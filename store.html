<html>
<head>
<script src="brython.js"></script>
</head>
<body onload="brython(1)">
<div style="background-color:#000000;width:1200px;margin:0 auto;color:#FFFFFF;">
<script type="text/python">
from browser import doc, alert
from limbo import async_request, sync_request, notify, redirect, Keycode

class Item():
    def __init__(self, database_row):
        self.name, self.seller, self.count, self.price, self.stock_date, \
            self.expiry_date, self.desc = database_row

class StoreSession():
    def __init__(self):
        username = doc.query.getfirst("username", "")
        sync_request(self.get_store_info_done, action="store_info", username=username)
        
        doc["in_stock"].bind("click", self.select_item_event)
        doc["in_stock"].bind("dblclick", self.checkout_event)
        doc["in_stock"].bind("keyup", self.checkout_all_event)
        
        doc["checkout"].bind("click", self.select_item_event)
        doc["checkout"].bind("dblclick", self.undo_checkout_event)
        doc["checkout"].bind("keyup", self.undo_checkout_all_event)
        
        doc["clear_button"].bind("click", self.clear_items_event)
        
        doc['search'].bind('keydown', self.search_event)
        doc['search'].bind('keyup', self.search_event)
        
        doc['payment'].bind('keyup', self.set_payment_event)
        self.payment = 0.0
    
    def set_payment_event(self, ev):
        try:
            self.payment = float(doc['payment'].value)
        except:
            self.payment = 0.0
        self.populate_lists()
    
    def populate_lists(self):
        """Fills the selection lists"""
        html = "<option value=\"{0}\" id=\"{0}\">{1}x {0} (${2})</option>"
            
        doc["in_stock"].html = ''.join(
            html.format(itemname,
                        amount,
                        self.inventory[itemname].price)
            for itemname, amount in self.in_stock.items())
        doc["checkout"].html = ''.join(
            html.format(itemname,
                        amount,
                        self.inventory[itemname].price)
            for itemname, amount in self.checkout.items())
        
        total = sum(amount * float(self.inventory[itemname].price)
                    for itemname, amount in self.checkout.items())
        doc["total"].html = "Your total is $%.2f" % total
        new_balance = self.balance - total + self.payment
        doc["new_balance"].html = "Your new balance will be $%.2f" % new_balance
        
        doc["my_stock"].html = ''.join(
			html.format(itemname,
                        item.count,
                        item.price)
            for itemname, item in self.my_stock.items())
			
    
    def get_store_info_done(self, t):
        userinfo, all_stock = t
        if not userinfo:
            # Invalid username
            redirect("index.html")
        username, email, balance, signup_date = userinfo
        self.balance = float(balance)
        doc["welcome"].html = ("Welcome, <b>%s</b>. Your balance is $%.2f." %
                               (username, self.balance))
        doc["new_balance"].html = ("Your new balance will be $%.2f" %
                                   self.balance)
        
        inventory_list = list(map(Item, all_stock))
        self.inventory = dict((item.name, item) for item in inventory_list)
        self.in_stock = dict((item.name, item.count) for item in inventory_list)
        self.checkout = {}
        
        self.my_stock = dict((item.name, item) for item in inventory_list if item.seller == username)
        
        self.populate_lists()
    
    def focus_test(self, ev):
        print("got focus on stock")
    
    def select_item_event(self, ev):
        """Single-clicking on an item should show its description"""
        item = self.inventory[ev.target.value]
        doc["description"].html = item.desc
    
    def select_item_key_event(self, ev):
        if ev.keyCode == Keycode.enter:
            self.checkout_event(ev)
        self.select_item_event(ev)
    
    def checkout_event(self, ev):
        """Double-clicking on inventory should add to self.checkout"""
        item = self.inventory[ev.target.value]
        if self.in_stock[item.name] == 0:
            return
        self.in_stock[item.name] -= 1
        if item.name not in self.checkout:
            self.checkout[item.name] = 1
        else:
            self.checkout[item.name] += 1
        self.populate_lists()

    def checkout_all_event(self, ev):
        """Pressing Enter on inventory should add all to self.checkout"""
        if ev.keyCode != Keycode.enter:
            # It's possible we just pressed an arrow key, changing the item
            # selection.
            self.select_item_key_event(ev)
            return
        item = self.inventory[ev.target.value]
        if self.in_stock[item.name] == 0:
            return
        if item.name not in self.checkout:
            self.checkout[item.name] = self.in_stock[item.name]
        else:
            self.checkout[item.name] += self.in_stock[item.name]
        self.in_stock[item.name] = 0
        self.populate_lists()

    def undo_checkout_event(self, ev):
        """Double-clicking on self.checkout items should remove them"""
        item = self.inventory[ev.target.value]
        self.checkout[item.name] -= 1
        self.in_stock[item.name] += 1
        if self.checkout[item.name] == 0:
            del self.checkout[item.name]
        self.populate_lists()

    def undo_checkout_all_event(self, ev):
        """Pressing delete on self.checkout items should remove them all"""
        if ev.keyCode != Keycode.delete:
            # It's possible we just pressed an arrow key, changing the item
            # selection.
            self.select_item_key_event(ev)
            return
        item = self.inventory[ev.target.value]
        self.in_stock[item.name] += self.checkout[item.name]
        del self.checkout[item.name]
        self.populate_lists()

    def clear_items_event(self, ev):
        for itemname in self.checkout:
            self.in_stock[itemname] += self.checkout[itemname]
        self.checkout = {}
        self.populate_lists()
    
    def search_event(self, ev):
        search_term = doc["search"].value.lower()
        # Hide all in_stock items which don't satisfy the search term
        all_hidden = True
        for option in doc["in_stock"].children:
            option.hidden = search_term not in option.value.lower()
            all_hidden = all_hidden and option.hidden
        # ...unless none of them satisfy the search term
        if all_hidden:
            for option in doc["in_stock"].children:
                option.hidden = False

StoreSession()
</script>

<center>
<a href="index.html"><img src="../images/limbo4.png" /></a>
<div id="welcome" style="font-size:20px;color:#00FFFF;"></div>
<br>
<br>
<br>
<br>
<br>
<table style="color:#FFFFFF;">
    <tr>
        <td><b>In Stock</b><br>double click to move to checkout, press enter to select all</td>
        <td><b>Checkout</b><br>double click to remove one, press delete to remove all</td>
    </tr>
    <tr>
        <td><input type="text" id="search" autofocus placeholder="Search"></td>
        <td><b id="total"></b>. <font id="new_balance"></font></td>
    </tr>
    <tr>
        <td><select size=10 style="width:500;height:200;" id="in_stock"></td>
        <td><select size=10 style="width:500;height:200;" id="checkout"></td>
    </tr>
    <tr>
        <td style="width:500;" id="description" rowspan=2></td>
        <td>
            <input type="submit" value="Clear All" id="clear_button">
        </td>
    </tr>
    <tr>
        <td>I'll pay you this much (negative to withdraw):<br>
            <input type="text" id="payment" value="0.00">
            <input type="submit" value="Checkout" id="checkout_button"></td>
    </tr>
    <tr>
        <td height="50px"></td>
        <td></td>
    </tr>
    <tr>
        <td style="width:500;">
            <b>My Inventory</b>
            <br>double click to remove one, press delete to remove all
        </td>
        <td><b>My Transactions History</b></td>
    </tr>
    <tr>
        <td><select size=10 style="width:500;height:200;" id="my_stock"></td>
        <td><select size=10 style="width:500;height:200;" id="sales"></td>
    </tr>
    <tr>
        <td height="50px"></td>
        <td></td>
    </tr>
    <tr>
        <td><b>Add Stock to Limbo:</b></td>
        <td></td>
    </tr>
    <tr>
        <td align="right">Item Name</td>
        <td><input type="text"></td>
    </tr>
    <tr>
        <td align="right">Count</td>
        <td><input type="text"></td>
    </tr>
    <tr>
        <td align="right">Description</td>
        <td><textarea rows="4" cols="50"></textarea></td>
    </tr>
    <tr>
        <td align="right">Expiration Time (weeks)</td>
        <td><input type="text"></td>
    </tr>
    <tr>
        <td align="right">List Price</td>
        <td><input type="text"></td>
    </tr>
    <tr>
        <td align="right">Sales Tax % (optional)</td>
        <td><input type="text"></td>
    </tr>
    <tr>
        <td align="right"><input type="submit" value="clear"></td>
        <td><input type="submit" value="add stock"></td>
    </tr>
</table>
<br>
<!-- This next part gets filled if there's an error -->
<b><div id="result" style="color:#000000;font-size:20px;background-color:#00FFFF;"></div></b>
<br>
<br>
<br>
<br>
</center>

</div>
</body>
</html>
