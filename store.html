<html>
<head>
<script src="brython.js"></script>
</head>
<body onload="brython(1)">
<div style="background-color:#000000;width:1200px;margin:0 auto;color:#FFFFFF;">
<script type="text/python">
from browser import doc, alert, html
from limbo import async_request, sync_request, notify, redirect, Keycode

class Item():
    def __init__(self, database_row):
        self.name, self.count, self.price, self.stock_date, \
            self.expiry_date, self.desc = database_row
    def __repr__(self):
        return "%s x%i" % (self.name, self.count)

class StoreSession():
    def __init__(self):
        self.username = doc.query.getfirst("username", "")
        sync_request(self.get_store_info_done,
                     action="store_info",
                     username=self.username)
        
    def get_store_info_done(self, t):
        userinfo, all_stock, usernames, user_stock = t
        self.usernames = usernames
        if not userinfo:
            # Invalid username
            redirect("index.html")
        username, email, balance, uid, signup_date = userinfo
        self.balance = float(balance)
        doc["welcome"].html = ("Welcome, <b>%s</b>. Your balance is $%.2f." %
                               (username, self.balance))
        doc["new_balance"].html = ("Your new balance will be $%.2f" %
                                   self.balance)
        
        # Build a list of all things in-stock
        inventory_list = list(map(Item, all_stock))
        self.inventory = dict((item.name, item) for item in inventory_list)
        self.in_stock = dict((item.name, item.count) for item in inventory_list)
        self.checkout = {}
        
        # And the user's own stock
        self.my_stock = dict((itemname, self.inventory[itemname]) for itemname in user_stock)

        self.payment = 0.0
        self.populate_lists()
        
        doc["in_stock"].bind("click", self.select_item_event)
        doc["in_stock"].bind("dblclick", self.checkout_event)
        doc["in_stock"].bind("keyup", self.checkout_all_event)
        
        doc["checkout"].bind("click", self.select_item_event)
        doc["checkout"].bind("dblclick", self.undo_checkout_event)
        doc["checkout"].bind("keyup", self.undo_checkout_all_event)
        
        doc["clear_button"].bind("click", self.clear_items_event)
        
        doc['search'].bind('keydown', self.search_event)
        doc['search'].bind('keyup', self.search_event)
        
        doc['payment'].bind('keyup', self.set_payment_event)
        self.payment = 0.0
        
        doc["inventory"].bind("dblclick", self.remove_inventory_event)
        doc["inventory"].bind("keyup", self.inventory_key_event)
        
        doc["add_seller"].bind("click", self.add_seller_space_event)
        self.seller_count = 1
        
        doc["usernames"].html = ''.join('<option value="%s">' % user
                                        for user in self.usernames
                                        if user != self.username)
        
        doc["add_item"].bind("click", self.stock_event)
        
        doc['price'].bind('keyup', self.change_profits_event)
        doc['tax'].bind('keyup', self.change_profits_event)
    
    def set_payment_event(self, ev):
        try:
            self.payment = float(doc['payment'].value)
        except:
            self.payment = 0.0
        self.populate_lists()
    
    def populate_lists(self):
        """Fills the selection lists"""
        html = "<option value=\"{0}\" id=\"{0}\">{1}x {0} (${2})</option>"
            
        doc["in_stock"].html = ''.join(
            html.format(itemname,
                        amount,
                        self.inventory[itemname].price)
            for itemname, amount in self.in_stock.items())
        doc["checkout"].html = ''.join(
            html.format(itemname,
                        amount,
                        self.inventory[itemname].price)
            for itemname, amount in self.checkout.items())
        
        total = sum(amount * float(self.inventory[itemname].price)
                    for itemname, amount in self.checkout.items())
        doc["total"].html = "Your total is $%.2f" % total
        new_balance = self.balance - total + self.payment
        doc["new_balance"].html = "Your new balance will be $%.2f" % new_balance
        
        doc["inventory"].html = ''.join(
            html.format(itemname,
                        item.count,
                        item.price)
            for itemname, item in self.my_stock.items())
    
    def select_item_event(self, ev):
        """Single-clicking on an item should show its description"""
        item = self.inventory[ev.target.value]
        doc["description"].html = item.desc
    
    def select_item_key_event(self, ev):
        if ev.keyCode == Keycode.enter:
            self.checkout_event(ev)
        self.select_item_event(ev)
    
    def checkout_event(self, ev):
        """Double-clicking on inventory should add to self.checkout"""
        item = self.inventory[ev.target.value]
        if self.in_stock[item.name] == 0:
            return
        self.in_stock[item.name] -= 1
        if item.name not in self.checkout:
            self.checkout[item.name] = 1
        else:
            self.checkout[item.name] += 1
        self.populate_lists()

    def checkout_all_event(self, ev):
        """Pressing Enter on inventory should add all to self.checkout"""
        if ev.keyCode != Keycode.enter:
            # It's possible we just pressed an arrow key, changing the item
            # selection.
            self.select_item_key_event(ev)
            return
        item = self.inventory[ev.target.value]
        if self.in_stock[item.name] == 0:
            return
        if item.name not in self.checkout:
            self.checkout[item.name] = self.in_stock[item.name]
        else:
            self.checkout[item.name] += self.in_stock[item.name]
        self.in_stock[item.name] = 0
        self.populate_lists()

    def undo_checkout_event(self, ev):
        """Double-clicking on self.checkout items should remove them"""
        item = self.inventory[ev.target.value]
        self.checkout[item.name] -= 1
        self.in_stock[item.name] += 1
        if self.checkout[item.name] == 0:
            del self.checkout[item.name]
        self.populate_lists()

    def undo_checkout_all_event(self, ev):
        """Pressing delete on self.checkout items should remove them all"""
        if ev.keyCode != Keycode.delete:
            # It's possible we just pressed an arrow key, changing the item
            # selection.
            self.select_item_key_event(ev)
            return
        item = self.inventory[ev.target.value]
        self.in_stock[item.name] += self.checkout[item.name]
        del self.checkout[item.name]
        self.populate_lists()

    def clear_items_event(self, ev):
        for itemname in self.checkout:
            self.in_stock[itemname] += self.checkout[itemname]
        self.checkout = {}
        self.populate_lists()
    
    def search_event(self, ev):
        search_term = doc["search"].value.lower()
        # Hide all in_stock items which don't satisfy the search term
        all_hidden = True
        for option in doc["in_stock"].children:
            option.hidden = search_term not in option.value.lower()
            all_hidden = all_hidden and option.hidden
        # ...unless none of them satisfy the search term
        if all_hidden:
            for option in doc["in_stock"].children:
                option.hidden = False
    
    def done_change_inventory(self, res):
        self.populate_lists()
    
    def inventory_key_event(self, ev):
        """Delete key or plus key on our personal stock"""
        if ev.keyCode == Keycode.delete:
            item = self.inventory[ev.target.value]
            async_request(done_change_inventory, action="remove", item=item, count="all")
        elif ev.keyCode == Keycode.plus:
            item = self.inventory[ev.target.value]
            async_request(done_change_inventory, action="add", item=item, count="1")
            
    def remove_inventory_event(self, ev):
        """Double click on our personal stock"""
        item = self.inventory[ev.target.value]
        async_request(done_change_inventory, action="remove", item=item, count="1")
    
    def add_seller_space_event(self, ev):
        """Fill in usernames autocomplete in stocking items form"""
        self.seller_count += 1
        # The text input uses the datalist tag to suggest autocomplete terms.
        # This is separate from browser autocomplete, which we want to specify as off.
        # The datalist tag is populated by get_usernames_done(). For explanation on
        # the datalist tag, see http://www.w3schools.com/tags/tag_datalist.asp
        ## There appears to be a strange error here where it thinks we're in
        ## the __main__ scope??
        seller_id = "additional_seller" + str(self.seller_count)
        profit_id = "additional_seller_profit" + str(self.seller_count)
        entry = html.TR(html.TD(html.INPUT(type="text",
                                           id=seller_id,
                                           list="usernames",
                                           autocomplete="off",
                                           placeholder="seller"),
                                align="right") +
                        html.TD(html.INPUT(type="text",
                                           placeholder="percent of profits",
                                           id=profit_id)))
        doc["stocking_table"] <= entry
        doc[profit_id].bind("keyup", self.change_profits_event)
    
    def change_profits_event(self, ev):
        values = [doc["additional_seller_profit" + str(seller + 2)].value
                  for seller in range(self.seller_count - 1)]
        total = 0.0
        for value in values:
            if value:
                total += float(value)
        total += float(doc["tax"].value)
        percent = 100.0 - total
        listed_price_each = float(doc["price"].value)
        doc["your_percentage"].html = str(percent) + '%'
        doc["your_income"].html = '$%.2f' % (percent * 0.01 * listed_price_each)
    
    def stock_event(self, ev):
        ## todo: check for existing items of the same name. We want to allow
        ## adding a number to existing stock.
        assert doc["itemname"].value
        assert int(doc["itemcount"].value)
        assert doc["description"].value
        assert int(doc["expiry"].value)
        assert float(doc["price"].value)
        assert float(doc["tax"].value)
        
        additional_sellers = [doc["additional_seller" + str(seller + 2)].value
                              for seller in range(self.seller_count - 1)]
        additional_seller_profits = [doc["additional_seller_profit" +
                                         str(seller + 2)].value
                                     for seller in range(self.seller_count - 1)]
        assert self.username not in additional_sellers
        sellers += [self.username]
        
        
        #~ async_request(self.stock_item_done,
                      #~ action="add_item",
                      #~ itemname=doc["itemname"].value,
                      #~ sellers=sellers,
                      #~ count=doc["itemcount"].value,
                      #~ price=doc["price"].value,
                      #~ expiry_time_in_weeks=doc["expiry"].value,
                      #~ description=doc["description"].value)

StoreSession()
</script>

<center>
<a href="index.html"><img src="../images/limbo4.png" /></a>
<div id="welcome" style="font-size:20px;color:#00FFFF;"></div>
<br>
<br>
<br>
<br>
<br>
<datalist id="usernames"></datalist>
<table style="color:#FFFFFF;" id="stocking_table">
    <tr>
        <td><b>In Stock</b><br>double click to move to checkout, press enter to select all</td>
        <td><b>Checkout</b><br>double click to remove one, press delete to remove all</td>
    </tr>
    <tr>
        <td><input type="text" id="search" autofocus placeholder="Search"></td>
        <td><b id="total"></b>. <font id="new_balance"></font></td>
    </tr>
    <tr>
        <td><select size=10 style="width:500;height:200;" id="in_stock"></td>
        <td><select size=10 style="width:500;height:200;" id="checkout"></td>
    </tr>
    <tr>
        <td style="width:500;" id="description" rowspan=2></td>
        <td>
            <input type="submit" value="Clear All" id="clear_button">
        </td>
    </tr>
    <tr>
        <td>I'll pay you this much (negative to withdraw):<br>
            <input type="text" id="payment" value="0.00">
            <input type="submit" value="Checkout" id="checkout_button"></td>
    </tr>
    <tr>
        <td height="50px"></td>
        <td></td>
    </tr>
    <tr>
        <td style="width:500;">
            <b>My Inventory</b>
            <br>double click to remove one, press delete to remove all
        </td>
        <td><b>My Transactions History</b></td>
    </tr>
    <tr>
        <td><select size=10 style="width:500;height:200;" id="inventory"></td>
        <td><select size=10 style="width:500;height:200;" id="sales"></td>
    </tr>
    <tr>
        <td><input type="submit" value="confirm" id="confirm_remove_inventory">
            <input type="submit" value="clear" id="clear_remove_inventory"></td>
        <td></td>
    </tr>
    <tr>
        <td height="50px"></td>
        <td></td>
    </tr>
    <tr>
        <td><b>Add Stock to Limbo:</b></td>
        <td></td>
    </tr>
    <tr>
        <td align="right">Item Name</td>
        <td><input type="text" id="itemname"></td>
    </tr>
    <tr>
        <td align="right">Count</td>
        <td><input type="text" id="itemcount"></td>
    </tr>
    <tr>
        <td align="right">Description</td>
        <td><textarea rows="4" cols="50" id="description"></textarea></td>
    </tr>
    <tr>
        <td align="right">Expiration Time</td>
        <td><input type="text" id="expiry" placeholder="weeks from now, max 52"></td>
    </tr>
    <tr>
        <td align="right">Listed Price Each</td>
        <td><input type="text" id="price"></td>
    </tr>
    <tr>
        <td align="right">Optional Sales Tax (in percent)</td>
        <td><input type="text" value="5.0" id="tax"><div id="profits_each"></div></td>
    </tr>
    <tr>
        <td align="right">Your Percentage of profits: <b id="your_percentage">95%</b></td>
        <td>Your income per item: <b id="your_income"></b></td>
    </tr>
    <tr>
        <td align="right">Add additional seller to split profits?</td>
        <td><input type="submit" value="add" id="add_seller"></td>
    </tr>
</table>
<table>
    <tr>
        <td align="right"><input type="submit" value="clear" id="clear_item"></td>
        <td><input type="submit" value="add stock" id="add_item"></td>
    </tr>
</table>
<br>
<!-- This next part gets filled if there's an error -->
<b><div id="result" style="color:#000000;font-size:20px;background-color:#00FFFF;"></div></b>
<br>
<br>
<br>
<br>
</center>

</div>
</body>
</html>
