<html>
<head>
<script src="brython.js"></script>
</head>
<body onload="brython(1)">
<div style="background-color:#000000;width:800px;margin:0 auto;color:#FFFFFF;">
<script type="text/python">
from browser import doc, alert
from limbo import async_request, notify, redirect, Keycode

class Item():
    def __init__(self, database_row):
        self.name, self.seller, self.count, self.price, self.stock_date, \
            self.expiry_date, self.desc = database_row

class StoreSession():
    def __init__(self):
        username = doc.query.getfirst("username", "")
        async_request(self.get_username_done, action="username", username=username)
        
        async_request(self.on_get_inventory, action="inventory")
        
        doc["in_stock"].bind("click", self.select_item_event)
        doc["in_stock"].bind("dblclick", self.checkout_event)
        doc["in_stock"].bind("keyup", self.select_item_key_event)
        
        doc["checkout"].bind("click", self.select_item_event)
        doc["checkout"].bind("dblclick", self.undo_checkout_event)
        
        doc["clear_button"].bind("click", self.clear_items_event)
        
    
    def populate_lists(self):
        """Fills the selection lists"""
        html = "<option value=\"{0}\" id=\"{0}\">{1}x {0} (${2})</option>"
            
        doc["in_stock"].html = ''.join(
            html.format(itemname,
                        amount,
                        self.inventory[itemname].price)
            for itemname, amount in self.in_stock.items())
        doc["checkout"].html = ''.join(
            html.format(itemname,
                        amount,
                        self.inventory[itemname].price)
            for itemname, amount in self.checkout.items())
        
        total = sum(amount * float(self.inventory[itemname].price)
                    for itemname, amount in self.checkout.items())
        doc["total"].html = "Your total is $%.2f" % total
    
    def get_username_done(self, data):
        """Check to see if we're given a valid username"""
        if not data:
            redirect("index.html")
        username, email, balance, signup_date = data
        doc["welcome"].html = ("Welcome, <b>%s</b>. Your balance is %d." %
                               (username, balance))
        
    def on_get_inventory(self, inventory_database_rows):
        inventory_list = list(map(Item, inventory_database_rows))
        self.inventory = dict((item.name, item) for item in inventory_list)
        self.in_stock = dict((item.name, item.count) for item in inventory_list)
        self.checkout = {}
        self.populate_lists()
    
    def focus_test(self, ev):
        print("got focus on stock")
    
    def select_item_event(self, ev):
        """Single-clicking on an item should show its description"""
        item = self.inventory[ev.target.value]
        doc["description"].html = item.desc
    
    def select_item_key_event(self, ev):
        if ev.keyCode == Keycode.enter:
            self.checkout_event(ev)
        else:
            self.select_item_event(ev)
    
    def checkout_event(self, ev):
        """Double-clicking on inventory should add to self.checkout"""
        item = self.inventory[ev.target.value]
        if self.in_stock[item.name] == 0:
            return
        self.in_stock[item.name] -= 1
        if item.name not in self.checkout:
            self.checkout[item.name] = 1
        else:
            self.checkout[item.name] += 1
        self.populate_lists()

    def undo_checkout_event(self, ev):
        """Double-clicking on self.checkout items should remove them"""
        item = self.inventory[ev.target.value]
        self.checkout[item.name] -= 1
        self.in_stock[item.name] += 1
        if self.checkout[item.name] == 0:
            del self.checkout[item.name]
        self.populate_lists()

    def clear_items_event(self, ev):
        for itemname in self.checkout:
            self.in_stock[itemname] += self.checkout[itemname]
        self.checkout = {}
        self.populate_lists()

StoreSession()
</script>

<center>
<a href="index.html"><img src="../images/limbo4.png" /></a>
<div id="welcome" style="font-size:20px;color:#00FFFF;"></div>
<br />
<br />
<br />
<br />
<br />
<table style="color:#FFFFFF;">
<tr><td>Inventory</td><td>Checkout <div id="total"></div></td>
</tr>
<tr>
<td><select size=10 style="width:300;" id="in_stock"></select></td>
<td><select size=10 style="width:300;" id="checkout"></select></td>
</tr>
<tr>
<td><div id="description" style="word-wrap:break-word;"></div></td>
<td><input type="submit" value="Clear" id="clear_button"></input>
<!-- <input type="submit" value="Checkout" id="checkout_button"></input></td> -->
</tr>
</table>
<br />
<!-- This next part gets filled if there's an error -->
<b><div id="result" style="color:#000000;font-size:20px;background-color:#00FFFF;"></div></b>
<br />
<br />
<br />
<br />
</center>

</div>
</body>
</html>
